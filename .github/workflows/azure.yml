on:
  push:
    branches:
      - master

env:
  AZURE_WEBAPP_NAME: NtFreX-Function-HelloWorld
  DOTNET_VERSION: '2.1.607'

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
    - name: 'Checkout git'
      uses: actions/checkout@master
      
    - name: 'Login via Azure CLI'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: 'Setup .NET Core ${{ env.DOTNET_VERSION }}'
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: 'Run dotnet build'
      shell: bash
      run: |
        pushd .
        dotnet build src/server/Azure.Functions.HelloWorld.csproj --configuration Release --output ./output
        popd
        
    - name: 'Deploy Azure Functions'
      uses: azure/functions-action@v1
      id: fa
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: './src/server/output'

    - name: 'Deploy static html'
      uses: SamKirkland/FTP-Deploy-Action@2.0.0
      env:
        FTP_SERVER: ${{ secrets.AZURE_FTP_PATH }}
        FTP_USERNAME: ${{ secrets.AZURE_FTP_USER }}
        FTP_PASSWORD: ${{ secrets.AZURE_FTP_PWD }}
        ARGS: --delete
        LOCAL_DIR: 'src/client'
